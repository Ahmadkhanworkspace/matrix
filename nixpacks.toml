[phases.setup]
nixPkgs = ["nodejs-18_x"]

[phases.install]
cmds = [
  "npm ci",
  "npm install --save @prisma/client prisma",
  "cd backend && npm install --save @prisma/client prisma && cd ..",
  "echo '=== Generating Prisma Client in root (for reference) ==='",
  "npx prisma generate --schema=./prisma/schema.prisma || echo 'Root generation failed (may be OK)'",
  "echo '=== Generating Prisma Client in backend (CRITICAL) ==='",
  "cd backend && npx prisma generate --schema=../prisma/schema.prisma && cd ..",
  "echo '=== Verifying backend generated client has real code ==='",
  "grep -q 'throw new Error' backend/node_modules/.prisma/client/default.js 2>&1 && echo '❌ Backend client still has stub!' || echo '✅ Backend client has real code (no stub found)'",
  "test -f backend/node_modules/.prisma/client/index.js && echo '✅ Backend .prisma/client/index.js exists' || echo '❌ Backend index.js missing'",
  "grep -q 'queryEngine' backend/node_modules/.prisma/client/index.js 2>&1 && echo '✅ Backend client has queryEngine' || echo '⚠️  queryEngine not found (may be OK)'",
  "echo 'Prisma setup complete'"
]

[phases.build]
cmds = ["npm run build"]

[start]
cmd = "node backend/src/server.js"

