[phases.setup]
nixPkgs = ["nodejs-18_x"]

[phases.install]
cmds = [
  "npm ci",
  "npm install --save @prisma/client prisma",
  "cd backend && npm install --save @prisma/client prisma && cd ..",
  "echo '=== Generating Prisma Client ==='",
  "npx prisma generate --schema=./prisma/schema.prisma",
  "echo '=== Verifying generated client has real code (not stub) ==='",
  "grep -q 'PrismaClient' node_modules/.prisma/client/index.js && echo '✅ Generated client has real code' || echo '❌ Generated client still has stub'",
  "echo '=== Copying generated client to backend ==='",
  "cd backend && mkdir -p node_modules/.prisma && rm -rf node_modules/.prisma/client && cp -r ../node_modules/.prisma/client node_modules/.prisma/client && echo '✅ Copied' || echo '❌ Copy failed'",
  "cd backend && mkdir -p node_modules/@prisma && rm -rf node_modules/@prisma/client && cp -r ../node_modules/@prisma/client node_modules/@prisma/client 2>&1 || ln -sf ../../node_modules/@prisma/client node_modules/@prisma/client 2>&1 || echo '❌ Failed to setup @prisma/client'",
  "cd .. && echo '=== Final Verification ==='",
  "test -f backend/node_modules/.prisma/client/index.js && echo '✅ .prisma/client/index.js in backend' || echo '❌ Missing index.js'",
  "grep -q 'queryEngine' backend/node_modules/.prisma/client/index.js 2>&1 && echo '✅ Backend client has real code' || echo '❌ Backend client may have stub'",
  "echo 'Prisma setup complete'"
]

[phases.build]
cmds = ["npm run build"]

[start]
cmd = "node backend/src/server.js"

