[phases.setup]
nixPkgs = ["nodejs-18_x"]

[phases.install]
cmds = [
  "npm ci",
  "npm install --save @prisma/client prisma",
  "cd backend && npm install --save @prisma/client prisma && cd ..",
  "echo '=== Generating Prisma Client in backend (CRITICAL) ==='",
  "cd backend && PRISMA_GENERATE_DATAPROXY=false npx prisma generate --schema=../prisma/schema.prisma 2>&1 && cd ..",
  "echo '=== Verifying Prisma Generation ==='",
  "ls -la backend/node_modules/.prisma/client/ 2>&1 | head -20 || echo 'Generated client directory not found'",
  "cat backend/node_modules/.prisma/client/index.js 2>&1 | head -5 || echo 'index.js not found'",
  "grep -q 'throw new Error.*did not initialize' backend/node_modules/.prisma/client/index.js 2>&1 && echo '❌ index.js still has stub!' || echo '✅ index.js has real code'",
  "test -f backend/node_modules/.prisma/client/index.d.ts && echo '✅ index.d.ts exists' || echo '❌ index.d.ts missing'",
  "echo 'Prisma setup complete'"
]

[phases.build]
cmds = ["npm run build"]

[start]
cmd = "node backend/src/server.js"

